# 要求内容

## GitHub Issue

https://github.com/k-negishi/ai-curated-newsletter/issues/4

## issue 内容

- **タイトル**: GHAでCI/CD構築
- **本文**: （空）
- **ラベル**: なし

## 概要

GitHub Actions（GHA）を使用してCI/CDパイプラインを構築し、PR作成時の自動テスト実行とmainブランチマージ時の自動デプロイを実現する。

## 背景

現在、テストとデプロイは手動で実行しており、以下の課題がある:

- **品質保証の課題**: PR作成時に手動でテストを実行する必要があり、テスト漏れのリスクがある
- **デプロイの課題**: mainマージ後に手動で `sam deploy` を実行する必要があり、デプロイ忘れやミスのリスクがある
- **開発効率の課題**: 手動作業が多く、開発フローが遅い

これらを解決するため、GitHub ActionsでCI/CDパイプラインを構築し、テストとデプロイを自動化する。

## 実装対象の機能

### 1. PR作成時のCI（継続的インテグレーション）

PRが作成・更新されたときに、以下のテストを自動実行:

- **ruff check**: リントチェック（コードスタイル、潜在的バグの検出）
- **ruff format --check**: フォーマットチェック（コード整形が正しいか確認）
- **mypy**: 型チェック（型ヒントの整合性確認）
- **pytest**: ユニットテスト実行（カバレッジ90%強制）

すべてのテストが通った場合のみ、PRマージ可能とする。

### 2. mainブランチマージ時のCI+CD（継続的デプロイ）

mainブランチにマージされたときに、以下を自動実行:

- **CI**: 上記テスト（ruff check, ruff format --check, mypy, pytest）を再実行
- **CD**: テスト成功後、AWS SAMを使ってproduction環境へ自動デプロイ

### 3. OIDC認証の設定

AWS認証にOIDC（OpenID Connect）を使用し、以下を実現:

- **セキュア**: アクセスキーを使用せず、一時的な認証トークンで認証
- **鍵管理不要**: GitHubシークレットにアクセスキーを保存する必要がない
- **IAMロール使用**: AWS IAMロールを使用した権限管理

## 受け入れ条件

### PR作成時のCI

- [ ] PRが作成されたとき、GitHub Actionsワークフローが自動的にトリガーされる
- [ ] ruff check が実行され、エラーがあればワークフローが失敗する
- [ ] ruff format --check が実行され、フォーマット不正があればワークフローが失敗する
- [ ] mypy が実行され、型エラーがあればワークフローが失敗する
- [ ] pytest が実行され、テスト失敗またはカバレッジ90%未満の場合にワークフローが失敗する
- [ ] すべてのテストが通った場合、PRマージが可能になる

### mainブランチマージ時のCI+CD

- [ ] mainブランチにマージされたとき、GitHub Actionsワークフローが自動的にトリガーされる
- [ ] CI（ruff check, ruff format --check, mypy, pytest）が再実行される
- [ ] CIが成功した場合のみ、CDステップに進む
- [ ] OIDC認証を使用してAWSに認証される
- [ ] AWS SAM CLI で `sam build` が実行される
- [ ] AWS SAM CLI で `sam deploy` が実行され、production環境にデプロイされる
- [ ] デプロイが成功した場合、ワークフローが成功する

### OIDC認証

- [ ] AWS IAMロールが作成され、GitHub Actions用の信頼ポリシーが設定されている
- [ ] GitHub ActionsワークフローでOIDC認証が設定され、一時的な認証トークンでAWSにアクセスできる
- [ ] アクセスキーをGitHubシークレットに保存する必要がない

## 成功指標

- **CI/CDの自動化**: PR作成時とmainマージ時に、手動操作なしでテストとデプロイが実行される
- **品質向上**: PRマージ前に必ずテストが実行され、品質が保証される
- **デプロイの確実性**: mainマージ後に確実にデプロイが実行され、デプロイ忘れがなくなる
- **セキュリティ向上**: OIDC認証により、アクセスキー管理が不要になる

## スコープ外

以下はこのフェーズでは実装しません:

- **staging環境へのデプロイ**: production環境のみ（個人開発のためシンプルに）
- **通知機能**: Slack通知などのアラート機能（Phase 2以降）
- **手動承認**: デプロイ前の手動承認ステップ（自動デプロイのみ）
- **ロールバック機能**: デプロイ失敗時の自動ロールバック（手動対応）
- **複数ブランチ戦略**: mainブランチのみ（develop, featureブランチのCI/CDは将来拡張）

## 実装方針

- **TDDサイクル**: Kent Beck の TDD (Test-Driven Development) で実装する
  - GitHub Actionsワークフローファイル自体はテストコードではないが、段階的に実装してテストする
  - まずCIワークフローを作成してPRでテスト、次にCDワークフローを追加してmainマージでテスト
- **最小限の実装**: 必要最小限の機能のみ実装し、拡張性は将来対応
- **ドキュメント重視**: OIDC設定手順をステップバイステップで記録し、再現可能にする

## 参照ドキュメント

- `docs/product-requirements.md` - プロダクト要求定義書
- `docs/functional-design.md` - 機能設計書
- `docs/architecture.md` - アーキテクチャ設計書（Phase 2でのCI/CD記載あり）
- `docs/development-guidelines.md` - 開発ガイドライン
